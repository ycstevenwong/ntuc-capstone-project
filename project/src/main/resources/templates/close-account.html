<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>
</head>
<body>
    <h1>Close Accounts Functions Test</h1>
    <hr>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
            <tr>
                <th>Index</th>
                <th>Account Number</th>
                <th>Test</th>
                <th>Test</th>
                <th>Test</th>
                <th>Test</th>
                <th>Operation</th>
            </tr>
            </thead>
            <tbody>
                <tr th:each="account, iterStat : ${accounts}">
                    <td th:text="${iterStat.count}"></td>
                    <td th:text="${account.accountNumber}"></td>
                    <td>test</td>
                    <td>test</td>
                    <td>test</td>
                    <td>test</td>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary"
                                    th:accountNo="${account.accountNumber}"
                                    th:customerName="${account.customer.name}"
                                    th:customerNric="${account.customer.nric}"
                                    th:accountType="${account.accountType.name}"
                                    th:accountBalance="${account.balance}"
                                    data-toggle="modal"
                                    data-target="#closeAccountModal">
                                Close Account
                            </button>

                            <button type="button" class="btn btn-danger"
                                    th:accountNo="${account.accountNumber}"
                                    th:customerName="${account.customer.name}"
                                    th:customerNric="${account.customer.nric}"
                                    th:accountType="${account.accountType.name}"
                                    th:accountBalance="${account.balance}"
                                    data-toggle="modal"
                                    data-target="#renewAccountModal">
                                Renew Account
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Close Account Modal -->
        <form method="post" action="/closeAccount/confirmClose">
            <div class="modal fade" data-backdrop="static" data-keyboard="false" id="closeAccountModal" tabindex="-1"
                  aria-labelledby="closeFunvtionModalLabel" aria-hidden="true" >
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="closeFunvtionModalLabel"></h4>
                            <button type="button" class="close" id="topCloseBtn" data-dismiss="modal"
                                    aria-hidden="true">x</button>
                        </div>
                        <div class="modal-body" id="closeAccountBody" style="margin-left: 35px">

                                <div class="form-group">
                                    <label class="col-3 control-label">Account Number</label>
                                    <div class="col-9">
                                        <input type="text" readonly class="form-control" id="accountNumber"
                                               name="accountNumber">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-3 control-label">Customer Name</label>
                                    <div class="col-9">
                                        <input type="text" readonly class="form-control" id="customerName">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-3 control-label">Customer NRIC</label>
                                    <div class="col-9">
                                        <input type="text" readonly class="form-control" id="customerNric">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-3 control-label">Account Type</label>
                                    <div class="col-9">
                                        <input type="text" readonly class="form-control" id="accountType">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-3 control-label">Account Balance</label>
                                    <div class="col-9">
                                        <input type="text" readonly class="form-control" id="accountBalance">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-3 control-label">* Confirm to close the account</label>
                                    <div class="col-9" style="margin-left: 600px;">
                                        <input type="checkbox" required value="CLOSED" id="closeConfirm"
                                               name="closeConfirm" style="width: 25px; height: 25px">
                                    </div>
                                </div>


                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" id="cancelBtn" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>


<!--         Renew Account Modal -->
        <form method="post" action="/closeAccount/confirmRenew">
            <div class="modal fade" data-backdrop="static" data-keyboard="false" id="renewAccountModal" tabindex="-1"
                 aria-labelledby="renewModalLabel" aria-hidden="true" >
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-renew-title" id="renewModalLabel"></h4>
                            <button type="button" class="close" data-dismiss="modal" id="renewCloseBtn"
                                    aria-hidden="true">x</button>
                        </div>
                        <div class="modal-body" id="renewAccountBody" style="margin-left: 35px">

                            <div class="form-group">
                                <label class="col-3 control-label">Account Number</label>
                                <div class="col-9">
                                    <input type="text" readonly class="form-control" id="renewAccountNumber"
                                           name="accountNumber">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-3 control-label">Customer Name</label>
                                <div class="col-9">
                                    <input type="text" readonly class="form-control" id="renewCustomerName">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-3 control-label">Customer NRIC</label>
                                <div class="col-9">
                                    <input type="text" readonly class="form-control" id="renewCustomerNric">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-3 control-label">Account Type</label>
                                <div class="col-9">
                                    <input type="text" readonly class="form-control" id="renewAccountType">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-3 control-label">* Confirm to renew the account</label>
                                <div class="col-9" style="margin-left: 600px;">
                                    <input type="checkbox" required value="AGREE" id="renewConfirm"
                                           name="renewConfirm" style="width: 25px; height: 25px">
                                </div>
                            </div>


                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" id="renewCancel" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="renewSubmit">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

    </div>

    <script>
        $( document ).ready(function() {

            // closeAccountModal
            $('#closeAccountModal').on('show.bs.modal', function(event) {
                let button = $(event.relatedTarget)
                let accountNo = button.attr("accountNo")
                let customerName = button.attr('customerName')
                let customerNric = button.attr('customerNric')
                let accountType = button.attr('accountType')
                let accountBalance = button.attr('accountBalance')
                let modal = $(this)

                modal.find('.modal-title').text('Close Account Application')
                modal.find('#accountNumber').val(accountNo)
                modal.find('#customerName').val(customerName)
                modal.find('#customerNric').val(customerNric)
                modal.find('#accountType').val(accountType)
                modal.find('#accountBalance').val(accountBalance)

                $('#closeConfirm').unbind('click').bind('click',function(){
                    if($("#closeConfirm").prop("checked")){
                        $.ajax({
                            url: "/closeAccount/getInterest/" + accountNo,
                            type: "GET",
                            dataType: "json",
                            success: function (data) {
                                $("#ulInterest").remove()
                                $('#inputInterest').remove()
                                let ul = $("<ul id='ulInterest'></ul>")
                                let li1 = "<li>Your balance is "+ modal.find('#accountBalance').val() +"</li>"
                                ul.append(li1)
                                let li2 = "<li>The card interest rate is "+ data.interestRate +"</li>"
                                ul.append(li2)
                                let li3 = "<li>Your interest after calculation is "+ data.interest +"</li>"
                                ul.append(li3)
                                let li4 = "<li>We will withdraw all your money</li>"
                                ul.append(li4)

                                $("#closeAccountBody").append(ul)

                                let inputInterest = "<input type='hidden' name='interest' id='inputInterest' value="+ data.interest +">"
                                $("#closeAccountBody").append(inputInterest)
                            }
                        })
                    } else{
                        $("#ulInterest").remove()
                        $('#inputInterest').remove()
                    }

                })

                $('#cancelBtn,#topCloseBtn').click(function () {
                    if($("#closeConfirm").prop("checked")){
                        $("#closeConfirm").prop("checked", false)
                        $("#ulInterest").remove()
                        $('#inputInterest').remove()
                    }
                })

            })


            // Renew Account

            $('#renewAccountModal').on('show.bs.modal', function(event) {
                let button = $(event.relatedTarget)
                let accountNo = button.attr("accountNo")
                let customerName = button.attr('customerName')
                let customerNric = button.attr('customerNric')
                let accountType = button.attr('accountType')
                let modal = $(this)

                modal.find('.modal-renew-title').text('Renew Account Application')
                modal.find('#renewAccountNumber').val(accountNo)
                modal.find('#renewCustomerName').val(customerName)
                modal.find('#renewCustomerNric').val(customerNric)
                modal.find('#renewAccountType').val(accountType)

                $('#renewConfirm').unbind('click').bind('click',function(){
                    if($("#renewConfirm").prop("checked")){
                        $.ajax({
                            url: "/closeAccount/renewAccount/" + accountNo,
                            type: "GET",
                            dataType: "json",
                            success: function (data) {
                                $("#ulRenew").remove()
                                $("#renewSubmit").attr("disabled", false)


                                let ul = $("<ul id='ulRenew'></ul>")
                                let li1 = "<li>Your account register time is "+ data.registerDate +"</li>"
                                ul.append(li1)
                                let li2 = "<li>Your account expiry time is "+ data.expiryTime +"</li>"
                                ul.append(li2)
                                let li3;
                                if(data.renewStatus){
                                    li3 = "<li>After renew, Your account expiry time is "+ data.renewTime +"</li>"
                                    ul.append(li3)
                                }else{
                                    li3 = "<li>You could not renew, because the account has expired</li>"
                                    ul.append(li3)
                                    $("#renewSubmit").attr("disabled", true)
                                }

                                $("#renewAccountBody").append(ul)

                            }
                        })
                    } else{
                        $("#ulRenew").remove()
                        $("#renewSubmit").attr("disabled", false)
                    }

                })

                $('#renewCancel,#renewCloseBtn').click(function () {
                    if($("#renewConfirm").prop("checked")){
                        $("#renewConfirm").prop("checked", false)
                        $("#ulRenew").remove()
                        $("#renewSubmit").attr("disabled", false)
                    }
                })

            })


        });

    </script>

</body>
</html>